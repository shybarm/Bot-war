<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bot-War — AI Trading MVP</title>

  <!-- Tailwind CDN for MVP speed (later: compile for production) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Small polish beyond Tailwind */
    .glass { background: rgba(255,255,255,.06); backdrop-filter: blur(10px); }
    .border-soft { border-color: rgba(255,255,255,.10); }
    .shadow-soft { box-shadow: 0 18px 40px rgba(0,0,0,.35); }
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      background-size: 200% 100%;
      animation: shimmer 1.2s infinite linear;
    }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>

<body class="min-h-screen bg-slate-950 text-white">
  <!-- Top gradient -->
  <div class="pointer-events-none fixed inset-0 opacity-60"
       style="background:
        radial-gradient(900px 500px at 20% 10%, rgba(99,102,241,.25), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(16,185,129,.12), transparent 60%),
        radial-gradient(900px 600px at 55% 90%, rgba(56,189,248,.12), transparent 60%);">
  </div>

  <div class="relative mx-auto max-w-6xl px-4 py-10 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
      <div>
        <div class="inline-flex items-center gap-2 rounded-full border border-soft glass px-3 py-1 text-xs text-white/70">
          <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
          Live MVP
        </div>
        <h1 class="mt-4 text-3xl font-semibold tracking-tight sm:text-4xl">
          Bot-War
          <span class="text-white/50">— market signals from price + news</span>
        </h1>
        <p class="mt-2 text-sm text-white/60 max-w-2xl">
          Compare strategies (long, swing, day) on the same inputs and see which logic wins — with explainable reasoning.
        </p>
      </div>

      <div class="flex items-center gap-3">
        <a id="healthLink" class="text-sm text-white/70 hover:text-white underline underline-offset-4" href="/api/health" target="_blank" rel="noreferrer">
          API Health
        </a>
        <button id="refreshBtn"
          class="rounded-xl border border-soft glass px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10 transition">
          Refresh
        </button>
      </div>
    </div>

    <!-- Search bar -->
    <div class="mt-8 rounded-2xl border border-soft glass shadow-soft">
      <div class="p-4 sm:p-5">
        <div class="flex flex-col gap-3 sm:flex-row sm:items-center">
          <div class="flex-1">
            <label class="text-xs text-white/60">Symbol</label>
            <div class="mt-1 flex items-center gap-2">
              <input id="sym"
                class="w-full rounded-xl bg-white/10 border border-soft px-4 py-3 text-white placeholder:text-white/40 outline-none focus:ring-2 focus:ring-indigo-500/60"
                placeholder="AAPL"
                value="AAPL" />
              <button id="runBtn"
                class="rounded-xl bg-indigo-500 px-5 py-3 text-sm font-semibold hover:bg-indigo-400 transition shadow-soft">
                Run
              </button>
            </div>
            <div class="mt-2 text-xs text-white/50">
              Try: <button class="chip" data-s="AAPL">AAPL</button>,
              <button class="chip" data-s="NVDA">NVDA</button>,
              <button class="chip" data-s="TSLA">TSLA</button>,
              <button class="chip" data-s="MSFT">MSFT</button>
            </div>
          </div>

          <div class="sm:w-64">
            <label class="text-xs text-white/60">Status</label>
            <div id="statusPill" class="mt-1 rounded-xl border border-soft bg-white/5 px-4 py-3 text-sm text-white/70">
              Ready
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Hero: Snapshot -->
    <div class="mt-6 grid gap-6 lg:grid-cols-3">
      <div class="lg:col-span-2 rounded-2xl border border-soft glass shadow-soft">
        <div class="p-5 sm:p-6">
          <div class="flex items-start justify-between gap-3">
            <div>
              <p class="text-xs text-white/50">Snapshot</p>
              <h2 class="mt-1 text-xl font-semibold tracking-tight">
                <span id="snapSymbol">—</span>
                <span class="text-white/40">•</span>
                <span id="snapPrice" class="tabular-nums text-white/90">—</span>
              </h2>
              <p id="snapChange" class="mt-1 text-sm text-white/60">—</p>
            </div>

            <div class="text-right">
              <p class="text-xs text-white/50">AI signal</p>
              <div id="aiSignalBadge" class="mt-2 inline-flex items-center rounded-full border border-soft bg-white/5 px-3 py-1 text-xs text-white/70">
                —
              </div>
            </div>
          </div>

          <div class="mt-5 border-t border-soft pt-5">
            <p class="text-xs text-white/50">AI reasoning</p>
            <p id="aiReasoning" class="mt-2 text-sm leading-6 text-white/70">
              Run an analysis to see the AI summary.
            </p>

            <div class="mt-4 grid gap-3 sm:grid-cols-3">
              <div class="rounded-xl border border-soft bg-white/5 p-4">
                <p class="text-xs text-white/50">Target</p>
                <p id="aiTarget" class="mt-1 text-base font-semibold tabular-nums">—</p>
              </div>
              <div class="rounded-xl border border-soft bg-white/5 p-4">
                <p class="text-xs text-white/50">Stop-loss</p>
                <p id="aiStop" class="mt-1 text-base font-semibold tabular-nums">—</p>
              </div>
              <div class="rounded-xl border border-soft bg-white/5 p-4">
                <p class="text-xs text-white/50">Horizon</p>
                <p id="aiHorizon" class="mt-1 text-base font-semibold">—</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bots Fight Hero Card -->
      <div class="rounded-2xl border border-soft glass shadow-soft">
        <div class="p-5 sm:p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-xs text-white/50">Bots Fight</p>
              <h2 class="mt-1 text-xl font-semibold tracking-tight">Winning strategy</h2>
            </div>
            <div id="winnerBadge" class="inline-flex items-center rounded-full border border-soft bg-white/5 px-3 py-1 text-xs text-white/70">
              —
            </div>
          </div>

          <div id="botsWrap" class="mt-5 space-y-3">
            <!-- bot cards injected -->
            <div class="rounded-xl border border-soft bg-white/5 p-4">
              <div class="h-3 w-2/3 skeleton rounded"></div>
              <div class="mt-3 h-3 w-1/2 skeleton rounded"></div>
              <div class="mt-4 h-2 w-full skeleton rounded"></div>
            </div>
          </div>

          <p id="botsNote" class="mt-4 text-xs text-white/50">
            Confidence blends current signal strength and historical accuracy (if learned data exists).
          </p>
        </div>
      </div>
    </div>

    <!-- News -->
    <div class="mt-6 rounded-2xl border border-soft glass shadow-soft">
      <div class="p-5 sm:p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-xs text-white/50">News</p>
            <h2 class="mt-1 text-xl font-semibold tracking-tight">Latest headlines</h2>
            <p class="mt-1 text-sm text-white/60">Top relevant articles with lightweight sentiment scoring.</p>
          </div>
          <div id="newsMeta" class="text-xs text-white/50">—</div>
        </div>

        <div id="newsList" class="mt-5 grid gap-3 sm:grid-cols-2">
          <!-- news cards injected -->
          <div class="rounded-xl border border-soft bg-white/5 p-4">
            <div class="h-3 w-3/4 skeleton rounded"></div>
            <div class="mt-3 h-3 w-1/2 skeleton rounded"></div>
            <div class="mt-4 h-2 w-full skeleton rounded"></div>
          </div>
          <div class="rounded-xl border border-soft bg-white/5 p-4">
            <div class="h-3 w-2/3 skeleton rounded"></div>
            <div class="mt-3 h-3 w-1/3 skeleton rounded"></div>
            <div class="mt-4 h-2 w-full skeleton rounded"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Market Overview -->
    <div class="mt-6 rounded-2xl border border-soft glass shadow-soft">
      <div class="p-5 sm:p-6">
        <div class="flex items-center justify-between gap-3">
          <div>
            <p class="text-xs text-white/50">Market Overview</p>
            <h2 class="mt-1 text-xl font-semibold tracking-tight">Quick watchlist</h2>
            <p class="mt-1 text-sm text-white/60">A fast snapshot of popular tickers.</p>
          </div>
          <button id="reloadMarket"
            class="rounded-xl border border-soft bg-white/5 px-4 py-2 text-sm text-white/80 hover:text-white hover:bg-white/10 transition">
            Reload
          </button>
        </div>

        <div class="mt-5 overflow-hidden rounded-xl border border-soft">
          <table class="w-full text-left text-sm">
            <thead class="bg-white/5 text-white/60">
              <tr>
                <th class="px-4 py-3 font-medium">Symbol</th>
                <th class="px-4 py-3 font-medium">Price</th>
                <th class="px-4 py-3 font-medium">% Change</th>
              </tr>
            </thead>
            <tbody id="marketTable" class="divide-y divide-white/10">
              <tr>
                <td class="px-4 py-3"><div class="h-3 w-16 skeleton rounded"></div></td>
                <td class="px-4 py-3"><div class="h-3 w-24 skeleton rounded"></div></td>
                <td class="px-4 py-3"><div class="h-3 w-20 skeleton rounded"></div></td>
              </tr>
              <tr>
                <td class="px-4 py-3"><div class="h-3 w-16 skeleton rounded"></div></td>
                <td class="px-4 py-3"><div class="h-3 w-24 skeleton rounded"></div></td>
                <td class="px-4 py-3"><div class="h-3 w-20 skeleton rounded"></div></td>
              </tr>
            </tbody>
          </table>
        </div>

        <p class="mt-3 text-xs text-white/50">
          Note: This is a lightweight MVP watchlist; deeper analytics will come from the learning layer.
        </p>
      </div>
    </div>

    <div class="mt-8 text-center text-xs text-white/40">
      MVP UI • Next: learning automation + bots performance curves
    </div>
  </div>

  <script>
    const API = window.location.origin;

    // Chips
    document.querySelectorAll(".chip").forEach(btn => {
      btn.className = "chip underline underline-offset-4 text-white/70 hover:text-white";
      btn.addEventListener("click", () => {
        document.getElementById("sym").value = btn.dataset.s;
        runAll();
      });
    });

    // Buttons
    document.getElementById("runBtn").addEventListener("click", runAll);
    document.getElementById("refreshBtn").addEventListener("click", () => location.reload());
    document.getElementById("reloadMarket").addEventListener("click", loadMarket);

    // Enter key runs
    document.getElementById("sym").addEventListener("keydown", (e) => {
      if (e.key === "Enter") runAll();
    });

    const fmtMoney = (n) => (typeof n === "number" && isFinite(n)) ? `$${n.toFixed(2)}` : "—";
    const fmtPct = (n) => (typeof n === "number" && isFinite(n)) ? `${n.toFixed(2)}%` : "—";

    function setStatus(text, tone="neutral") {
      const el = document.getElementById("statusPill");
      el.textContent = text;

      el.className = "mt-1 rounded-xl border px-4 py-3 text-sm";
      if (tone === "ok") el.classList.add("border-emerald-400/30","bg-emerald-500/10","text-emerald-100");
      else if (tone === "bad") el.classList.add("border-rose-400/30","bg-rose-500/10","text-rose-100");
      else el.classList.add("border-white/10","bg-white/5","text-white/70");
    }

    async function fetchJson(url, opts) {
      const r = await fetch(url, opts);
      const t = await r.text();
      let j;
      try { j = JSON.parse(t); } catch { j = { raw: t }; }
      if (!r.ok) {
        const msg = j?.error || `Request failed (${r.status})`;
        throw new Error(msg);
      }
      return j;
    }

    function signalBadge(signal) {
      const s = (signal || "").toUpperCase();
      if (s === "BUY") return ["BUY", "bg-emerald-500/15 text-emerald-200 border-emerald-400/25"];
      if (s === "SELL") return ["SELL", "bg-rose-500/15 text-rose-200 border-rose-400/25"];
      return ["HOLD", "bg-white/5 text-white/70 border-white/10"];
    }

    function strategyLabel(strategy) {
      if (strategy === "sp500_long") return "Long S&P Strategy";
      if (strategy === "market_swing") return "Market Swing Strategy";
      if (strategy === "day_trade") return "Day Trading Strategy";
      return strategy || "—";
    }

    function horizonLabel(h) {
      const x = (h || "").toLowerCase();
      if (x === "short") return "Short";
      if (x === "medium") return "Medium";
      if (x === "long") return "Long";
      return h || "—";
    }

    function renderBots(data) {
      const wrap = document.getElementById("botsWrap");
      wrap.innerHTML = "";

      const winner = data?.winner || null;
      const bots = data?.bots || [];

      const wb = document.getElementById("winnerBadge");
      wb.textContent = winner ? `Winner: ${strategyLabel(winner)}` : "—";
      wb.className = "inline-flex items-center rounded-full border px-3 py-1 text-xs";
      wb.classList.add("border-white/10","bg-white/5","text-white/70");

      if (!bots.length) {
        wrap.innerHTML = `<div class="text-sm text-white/60">No bot data returned.</div>`;
        return;
      }

      bots.forEach((b, idx) => {
        const isWinner = b.strategy === winner;
        const [sigText, sigClass] = signalBadge(b.signal);

        const conf = typeof b.confidence === "number" ? b.confidence : 50;
        const hist = typeof b.historicalAccuracy === "number" ? b.historicalAccuracy : null;
        const samples = typeof b.samples === "number" ? b.samples : 0;

        const card = document.createElement("div");
        card.className = "rounded-xl border bg-white/5 p-4 transition";
        card.classList.add("border-white/10");
        if (isWinner) card.classList.add("ring-2","ring-indigo-400/40","bg-indigo-500/10");

        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div>
              <div class="text-sm font-semibold">${strategyLabel(b.strategy)}</div>
              <div class="mt-1 text-xs text-white/60">${horizonLabel(b.horizon)} horizon • ${b.rationale || "—"}</div>
            </div>
            <div class="inline-flex items-center rounded-full border px-2.5 py-1 text-xs ${sigClass}">
              ${sigText}
            </div>
          </div>

          <div class="mt-4">
            <div class="flex items-center justify-between text-xs text-white/60">
              <span>Confidence</span>
              <span class="tabular-nums">${conf}%</span>
            </div>
            <div class="mt-2 h-2 w-full rounded-full bg-white/10 overflow-hidden">
              <div class="h-full rounded-full bg-white/60" style="width:${Math.max(1, Math.min(100, conf))}%"></div>
            </div>
          </div>

          <div class="mt-3 flex items-center justify-between text-xs text-white/60">
            <span>Historical accuracy</span>
            <span class="tabular-nums">${hist === null ? "—" : `${hist}%`} ${samples ? `(${samples})` : ""}</span>
          </div>
        `;
        wrap.appendChild(card);
      });
    }

    function renderNews(symbol, newsArr) {
      const list = document.getElementById("newsList");
      const meta = document.getElementById("newsMeta");
      list.innerHTML = "";

      const items = (newsArr || []).slice(0, 8);

      meta.textContent = items.length ? `${items.length} articles for ${symbol}` : `No articles for ${symbol}`;

      if (!items.length) {
        list.innerHTML = `<div class="text-sm text-white/60">No news returned. Try another symbol.</div>`;
        return;
      }

      items.forEach((n) => {
        const s = typeof n.sentiment === "number" ? n.sentiment : 0;
        const tag =
          s > 0.15 ? ["Positive", "border-emerald-400/25 bg-emerald-500/10 text-emerald-200"] :
          s < -0.15 ? ["Negative", "border-rose-400/25 bg-rose-500/10 text-rose-200"] :
          ["Neutral", "border-white/10 bg-white/5 text-white/70"];

        const card = document.createElement("a");
        card.href = n.url || "#";
        card.target = "_blank";
        card.rel = "noreferrer";
        card.className = "block rounded-xl border border-soft bg-white/5 p-4 hover:bg-white/10 transition";

        const date = n.publishedAt ? new Date(n.publishedAt).toLocaleString() : "";
        card.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="text-sm font-semibold leading-5">${n.title || "Untitled"}</div>
            <div class="shrink-0 inline-flex items-center rounded-full border px-2.5 py-1 text-xs ${tag[1]}">${tag[0]}</div>
          </div>
          <div class="mt-2 text-xs text-white/60">${n.source || "Unknown"} ${date ? "• " + date : ""}</div>
          <div class="mt-3 text-sm text-white/70 line-clamp-2">${n.description || ""}</div>
        `;
        list.appendChild(card);
      });
    }

    function renderAnalyze(data) {
      const symbol = data?.symbol || "—";
      const quote = data?.quote || {};
      const analysis = data?.analysis || {};

      document.getElementById("snapSymbol").textContent = symbol;
      document.getElementById("snapPrice").textContent = fmtMoney(quote.price);

      const changePct = quote.changePercent;
      const changeTone = (typeof changePct === "number")
        ? (changePct > 0 ? "text-emerald-200" : (changePct < 0 ? "text-rose-200" : "text-white/70"))
        : "text-white/70";

      document.getElementById("snapChange").innerHTML =
        `<span class="${changeTone} font-semibold tabular-nums">${fmtPct(changePct)}</span>
         <span class="text-white/50"> today</span>`;

      const [sigText, sigClass] = signalBadge(analysis.signal);
      const badge = document.getElementById("aiSignalBadge");
      badge.textContent = `${sigText} • ${typeof analysis.confidence === "number" ? analysis.confidence + "%" : "—"}`;
      badge.className = "mt-2 inline-flex items-center rounded-full border px-3 py-1 text-xs";
      badge.classList.add(...sigClass.split(" "));

      document.getElementById("aiReasoning").textContent =
        analysis.reasoning || "No AI reasoning returned.";

      document.getElementById("aiTarget").textContent =
        (typeof analysis.targetPrice === "number") ? fmtMoney(analysis.targetPrice) : "—";

      document.getElementById("aiStop").textContent =
        (typeof analysis.stopLoss === "number") ? fmtMoney(analysis.stopLoss) : "—";

      document.getElementById("aiHorizon").textContent =
        analysis.timeHorizon ? analysis.timeHorizon : "—";
    }

    function renderMarket(rows) {
      const tb = document.getElementById("marketTable");
      tb.innerHTML = "";

      (rows || []).forEach(r => {
        const tr = document.createElement("tr");
        const ch = r?.change;
        const tone = (typeof ch === "number")
          ? (ch > 0 ? "text-emerald-200" : (ch < 0 ? "text-rose-200" : "text-white/70"))
          : "text-white/70";

        tr.innerHTML = `
          <td class="px-4 py-3 font-semibold">${r.symbol || "—"}</td>
          <td class="px-4 py-3 tabular-nums text-white/80">${fmtMoney(r.price)}</td>
          <td class="px-4 py-3 tabular-nums ${tone}">${fmtPct(ch)}</td>
        `;
        tb.appendChild(tr);
      });

      if (!rows || !rows.length) {
        tb.innerHTML = `<tr><td class="px-4 py-4 text-white/60" colspan="3">No market data returned.</td></tr>`;
      }
    }

    async function loadMarket() {
      try {
        const data = await fetchJson(`${API}/api/market-overview`);
        renderMarket(data);
      } catch (e) {
        renderMarket([]);
      }
    }

    function setLoadingState() {
      setStatus("Running…", "neutral");

      // Bots skeleton
      document.getElementById("botsWrap").innerHTML = `
        <div class="rounded-xl border border-soft bg-white/5 p-4">
          <div class="h-3 w-2/3 skeleton rounded"></div>
          <div class="mt-3 h-3 w-1/2 skeleton rounded"></div>
          <div class="mt-4 h-2 w-full skeleton rounded"></div>
        </div>
        <div class="rounded-xl border border-soft bg-white/5 p-4">
          <div class="h-3 w-3/4 skeleton rounded"></div>
          <div class="mt-3 h-3 w-1/3 skeleton rounded"></div>
          <div class="mt-4 h-2 w-full skeleton rounded"></div>
        </div>
      `;

      // News skeleton
      document.getElementById("newsList").innerHTML = `
        <div class="rounded-xl border border-soft bg-white/5 p-4">
          <div class="h-3 w-3/4 skeleton rounded"></div>
          <div class="mt-3 h-3 w-1/2 skeleton rounded"></div>
          <div class="mt-4 h-2 w-full skeleton rounded"></div>
        </div>
        <div class="rounded-xl border border-soft bg-white/5 p-4">
          <div class="h-3 w-2/3 skeleton rounded"></div>
          <div class="mt-3 h-3 w-1/3 skeleton rounded"></div>
          <div class="mt-4 h-2 w-full skeleton rounded"></div>
        </div>
      `;
      document.getElementById("newsMeta").textContent = "Loading…";
    }

    async function runAll() {
      const s = (document.getElementById("sym").value || "AAPL").toUpperCase().trim();
      document.getElementById("sym").value = s;

      setLoadingState();

      try {
        const [an, bots, news] = await Promise.all([
          fetchJson(`${API}/api/analyze/${encodeURIComponent(s)}`),
          fetchJson(`${API}/api/bots/${encodeURIComponent(s)}`),
          fetchJson(`${API}/api/news/${encodeURIComponent(s)}`)
        ]);

        renderAnalyze(an);
        renderBots(bots);
        renderNews(s, news?.news || []);

        setStatus("Done", "ok");
      } catch (e) {
        setStatus(`Error: ${e.message}`, "bad");
      }
    }

    // Boot
    loadMarket();
  </script>
</body>
</html>
