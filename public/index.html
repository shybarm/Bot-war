<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Trading Arena</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{
      background: radial-gradient(1200px 700px at 20% 10%, rgba(120,119,198,.28), transparent 60%),
                  radial-gradient(900px 600px at 85% 25%, rgba(236,72,153,.18), transparent 60%),
                  radial-gradient(900px 700px at 70% 85%, rgba(34,197,94,.10), transparent 55%),
                  #060712;
      color: #e7e9ff;
    }
    .glass{
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 20px 80px rgba(0,0,0,0.35);
      backdrop-filter: blur(14px);
    }
    .muted{ color: rgba(231,233,255,0.65); }
    .chip{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .btn{
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
    }
    .btn:hover{ background: rgba(255,255,255,0.06); }
    .row:hover{ background: rgba(255,255,255,0.04); }
    a{ color: inherit; }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-7xl mx-auto px-5 py-10">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
      <div>
        <div class="text-4xl font-bold tracking-tight">AI Trading Arena</div>
        <div class="mt-2 muted max-w-2xl">
          General news → impacted tickers, with audit-grade evidence.
          This experience is designed to “show the research.”
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <a href="/war-room.html" class="btn px-4 py-2 rounded-xl text-sm font-medium">⚔️ War Room</a>
        <a href="/runner-status.html" class="btn px-4 py-2 rounded-xl text-sm font-medium">Runner Status</a>
        <button id="howBtn" class="btn px-4 py-2 rounded-xl text-sm font-medium">How it works</button>

        <span id="apiChip" class="chip px-3 py-2 rounded-xl text-xs muted">API: {}</span>
        <span id="wsChip" class="chip px-3 py-2 rounded-xl text-xs">
          WS: <span class="muted">connecting…</span>
        </span>
      </div>
    </div>

    <!-- Main grid -->
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mt-8">
      <!-- Left: General news -->
      <div class="lg:col-span-7 glass rounded-2xl p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-semibold">Top 8 General News → Market Impact</div>
            <div class="muted text-sm mt-1">Click a headline to see impacted tickers + evidence.</div>
          </div>
          <span id="newsProvider" class="chip px-3 py-1.5 rounded-xl text-xs muted">Provider: —</span>
        </div>

        <div id="newsList" class="mt-5 space-y-3">
          <div class="muted">Loading…</div>
        </div>

        <div id="newsEmpty" class="hidden mt-5 chip rounded-xl p-4">
          <div class="font-semibold">No general news available</div>
          <div class="muted text-sm mt-1">Configure NEWS keys or fallback will populate.</div>
        </div>
      </div>

      <!-- Right column -->
      <div class="lg:col-span-5 glass rounded-2xl p-6">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-xl font-semibold">Market Pulse</div>
            <div class="muted text-sm mt-1">Live prices + % change for a reference basket.</div>
          </div>
          <span id="marketChip" class="chip px-3 py-1.5 rounded-xl text-xs muted">Market: —</span>
        </div>

        <div class="mt-4 overflow-hidden rounded-xl border border-white/10">
          <table class="w-full text-sm">
            <thead class="bg-white/5">
              <tr>
                <th class="text-left px-3 py-2 muted font-medium">Symbol</th>
                <th class="text-right px-3 py-2 muted font-medium">Price</th>
                <th class="text-right px-3 py-2 muted font-medium">Chg%</th>
                <th class="text-right px-3 py-2 muted font-medium">Src</th>
              </tr>
            </thead>
            <tbody id="pulseBody" class="divide-y divide-white/5">
              <tr><td class="px-3 py-3 muted" colspan="4">Loading…</td></tr>
            </tbody>
          </table>
        </div>

        <div class="mt-6 pt-6 border-t border-white/10">
          <div class="text-lg font-semibold">Learning Impact (Last 14 days)</div>
          <div class="muted text-sm mt-1">Accuracy trend by strategy — evaluates after the horizon, then updates weights.</div>
          <div class="mt-4">
            <canvas id="impactChart" height="170"></canvas>
          </div>
          <div id="learnEmpty" class="hidden mt-4 chip rounded-xl p-4">
            <div class="font-semibold">No learning outcomes yet</div>
            <div class="muted text-sm mt-1">
              Learning samples appear immediately, but outcomes only appear after the evaluation horizon.
              Switch to “Accelerated” learning mode to see results faster.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Article Impact Modal -->
  <div id="impactModal" class="fixed inset-0 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="glass w-full max-w-2xl rounded-2xl p-6">
        <div class="flex items-start justify-between gap-4">
          <div class="min-w-0">
            <div id="modalTitle" class="text-xl font-semibold leading-snug">—</div>
            <div id="modalMeta" class="muted text-sm mt-1">—</div>
          </div>
          <button id="modalClose" class="btn px-4 py-2 rounded-xl text-sm font-medium">Close</button>
        </div>

        <div id="modalSummary" class="muted mt-4">—</div>

        <div class="mt-5">
          <div class="text-sm font-semibold">Impacted tickers</div>
          <div id="modalTickers" class="mt-2 flex flex-wrap gap-2"></div>
          <div id="modalWhy" class="muted text-sm mt-3">—</div>

          <div class="mt-4 chip rounded-xl p-4">
            <div class="text-sm font-semibold">Evidence (explainable)</div>
            <div id="modalEvidence" class="muted text-sm mt-1">—</div>
          </div>
        </div>

        <div class="mt-5 flex items-center justify-between">
          <a id="modalLink" href="#" target="_blank" class="btn px-4 py-2 rounded-xl text-sm font-medium">
            Open article ↗
          </a>
          <div id="modalConf" class="chip px-3 py-2 rounded-xl text-xs muted">—</div>
        </div>
      </div>
    </div>
  </div>

  <!-- How it works modal -->
  <div id="howModal" class="fixed inset-0 hidden">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="glass w-full max-w-3xl rounded-2xl p-6">
        <div class="flex items-center justify-between gap-4">
          <div class="text-xl font-semibold">How This System Works</div>
          <button id="howClose" class="btn px-4 py-2 rounded-xl text-sm font-medium">Close</button>
        </div>

        <div class="muted text-sm mt-2">
          A lightweight “observe → decide → act/simulate → learn → repeat” loop.
          The key is that learning outcomes persist and influence future confidence.
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-5">
          <div class="chip rounded-xl p-4">
            <div class="font-semibold">1) Observe</div>
            <div class="muted text-sm mt-1">Prices + % change + news sentiment are computed into features.</div>
          </div>
          <div class="chip rounded-xl p-4">
            <div class="font-semibold">2) Decide</div>
            <div class="muted text-sm mt-1">Each bot outputs BUY / SELL / HOLD with a confidence score.</div>
          </div>
          <div class="chip rounded-xl p-4">
            <div class="font-semibold">3) Act or simulate</div>
            <div class="muted text-sm mt-1">During market hours it trades; when closed it logs paper decisions.</div>
          </div>
          <div class="chip rounded-xl p-4">
            <div class="font-semibold">4) Learn</div>
            <div class="muted text-sm mt-1">After a horizon, outcomes are marked correct/incorrect and weights update.</div>
          </div>
        </div>

        <div class="mt-5 chip rounded-xl p-4">
          <div class="font-semibold text-sm">What you should watch</div>
          <div class="muted text-sm mt-1">
            If Learning Impact is empty, it means you have signals but not enough evaluated outcomes yet.
            If General News is “mock”, you need to set a news provider key.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function fmtPct(x){
    const n = Number(x || 0);
    const s = (Math.round(n * 1000) / 1000).toFixed(3);
    return (n >= 0 ? "+" : "") + s;
  }
  function fmtPrice(x){
    const n = Number(x || 0);
    return n.toLocaleString(undefined, { maximumFractionDigits: 3 });
  }
  function timeAgo(iso){
    if(!iso) return "";
    const t = new Date(iso).getTime();
    if(!Number.isFinite(t)) return "";
    const d = Math.max(0, Date.now() - t);
    const m = Math.floor(d/60000);
    if(m < 1) return "just now";
    if(m < 60) return m + "m ago";
    const h = Math.floor(m/60);
    if(h < 24) return h + "h ago";
    const days = Math.floor(h/24);
    return days + "d ago";
  }

  function connectWS(){
    const proto = location.protocol === "https:" ? "wss" : "ws";
    const url = proto + "://" + location.host + "/ws";
    const ws = new WebSocket(url);

    ws.onopen = () => {
      $("wsChip").innerHTML = 'WS: <span class="text-emerald-300">live ✅</span>';
    };
    ws.onclose = () => {
      $("wsChip").innerHTML = 'WS: <span class="text-amber-300">closed ⚠️</span>';
      setTimeout(connectWS, 1500);
    };
    ws.onerror = () => {};
    ws.onmessage = () => {};
  }

  let lastGeneralNews = [];

  async function loadGeneralNews(){
    try{
      const r = await fetch("/api/news/general?limit=8");
      const j = await r.json();

      $("newsProvider").textContent = "Provider: " + (j.provider || "—");
      lastGeneralNews = Array.isArray(j.items) ? j.items : [];

      if(!lastGeneralNews.length){
        $("newsList").innerHTML = "";
        $("newsEmpty").classList.remove("hidden");
        return;
      }

      $("newsEmpty").classList.add("hidden");

      $("newsList").innerHTML = lastGeneralNews.map((a, idx) => {
        const imp = a.impact || {};
        const tickers = (imp.tickers || []).slice(0, 6);
        const chips = tickers.map(t => `<span class="chip px-2 py-1 rounded-lg text-xs">${t}</span>`).join("");
        const published = a.publishedAt ? timeAgo(a.publishedAt) : "";

        return `
          <button class="w-full text-left chip rounded-xl p-4 row" data-idx="${idx}">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold leading-snug">${escapeHtml(a.title || "")}</div>
                <div class="muted text-xs mt-1">${escapeHtml(a.source || "—")} • ${escapeHtml(published)}</div>
              </div>
              <div class="shrink-0 muted text-xs">${imp.horizon ? ("Horizon: " + imp.horizon) : ""}</div>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">${chips || `<span class="muted text-sm">No impacted tickers inferred</span>`}</div>
          </button>
        `;
      }).join("");

      [...$("newsList").querySelectorAll("button[data-idx]")].forEach(btn => {
        btn.addEventListener("click", () => openImpactModal(Number(btn.dataset.idx)));
      });

    }catch(e){
      $("newsProvider").textContent = "Provider: error";
      $("newsList").innerHTML = `<div class="chip rounded-xl p-4"><div class="font-semibold">News failed to load</div><div class="muted text-sm mt-1">${escapeHtml(String(e.message || e))}</div></div>`;
    }
  }

  function openImpactModal(idx){
    const a = lastGeneralNews[idx];
    if(!a) return;

    const imp = a.impact || {};
    $("modalTitle").textContent = a.title || "—";
    $("modalMeta").textContent = `${a.source || "—"} • ${a.publishedAt ? timeAgo(a.publishedAt) : ""}`;
    $("modalSummary").textContent = a.summary || "—";
    $("modalWhy").textContent = imp.why || "—";
    $("modalEvidence").textContent = (imp.ruleHits && imp.ruleHits.length)
      ? `Matched impact routes: ${imp.ruleHits.join(", ")}`
      : "Heuristic mapping (no explicit rule hits).";
    $("modalConf").textContent = `Confidence: ${imp.confidence ?? "—"} • Horizon: ${imp.horizon ?? "—"}`;
    $("modalLink").href = a.url || "#";

    const tickers = (imp.tickers || []);
    $("modalTickers").innerHTML = tickers.length
      ? tickers.map(t => `<a class="chip px-3 py-1.5 rounded-xl text-sm hover:bg-white/10" href="/war-room.html#${t}">${t}</a>`).join("")
      : `<span class="muted text-sm">No impacted tickers inferred for this headline.</span>`;

    $("impactModal").classList.remove("hidden");
  }

  function closeImpactModal(){
    $("impactModal").classList.add("hidden");
  }

  async function loadMarketPulse(){
    try{
      const r = await fetch("/api/market/pulse");
      const j = await r.json();

      const m = j.market || {};
      $("marketChip").textContent = `Market: ${m.open ? "OPEN" : "CLOSED"} (${m.reason || ""})`;

      const items = Array.isArray(j.items) ? j.items : [];
      if(!items.length){
        $("pulseBody").innerHTML = `<tr><td class="px-3 py-3 muted" colspan="4">No symbols returned</td></tr>`;
        return;
      }

      $("pulseBody").innerHTML = items.map(x => `
        <tr class="row">
          <td class="px-3 py-2 font-medium">${escapeHtml(x.symbol || "")}</td>
          <td class="px-3 py-2 text-right">${fmtPrice(x.price)}</td>
          <td class="px-3 py-2 text-right muted">${fmtPct(x.changePercent)}%</td>
          <td class="px-3 py-2 text-right muted">${escapeHtml(x.provider || "—")}</td>
        </tr>
      `).join("");

    }catch(e){
      $("pulseBody").innerHTML = `<tr><td class="px-3 py-3 muted" colspan="4">Pulse failed: ${escapeHtml(String(e.message || e))}</td></tr>`;
    }
  }

  let impactChart = null;

  async function loadLearningImpact(){
    try{
      const r = await fetch("/api/learning/impact?days=14");
      const j = await r.json();

      const series = Array.isArray(j.series) ? j.series : [];
      if(!series.length){
        $("learnEmpty").classList.remove("hidden");
        if(impactChart){ impactChart.destroy(); impactChart = null; }
        return;
      }
      $("learnEmpty").classList.add("hidden");

      const days = Array.from(new Set(series.flatMap(s => s.points.map(p => p.day)))).sort();

      const datasets = series.map(s => {
        const byDay = Object.fromEntries(s.points.map(p => [p.day, p.accuracy]));
        const data = days.map(d => (d in byDay ? byDay[d] : null));
        return {
          label: s.strategy,
          data,
          spanGaps: true,
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25
        };
      });

      const ctx = $("impactChart").getContext("2d");
      if(impactChart) impactChart.destroy();

      impactChart = new Chart(ctx, {
        type: "line",
        data: { labels: days, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: "rgba(231,233,255,0.75)" } },
            tooltip: { enabled: true }
          },
          scales: {
            x: { ticks: { color: "rgba(231,233,255,0.55)" }, grid: { color: "rgba(255,255,255,0.06)" } },
            y: { ticks: { color: "rgba(231,233,255,0.55)" }, grid: { color: "rgba(255,255,255,0.06)" }, suggestedMin: 0, suggestedMax: 100 }
          }
        }
      });

    }catch(e){
      $("learnEmpty").classList.remove("hidden");
    }
  }

  async function loadHealth(){
    try{
      const r = await fetch("/api/health");
      const j = await r.json();
      $("apiChip").textContent = "API: " + JSON.stringify({ postgres: !!j.postgres });
    }catch{
      $("apiChip").textContent = "API: error";
    }
  }

  $("howBtn").addEventListener("click", () => $("howModal").classList.remove("hidden"));
  $("howClose").addEventListener("click", () => $("howModal").classList.add("hidden"));
  $("modalClose").addEventListener("click", closeImpactModal);
  $("impactModal").addEventListener("click", (e) => { if(e.target === $("impactModal").children[0]) closeImpactModal(); });
  $("howModal").addEventListener("click", (e) => { if(e.target === $("howModal").children[0]) $("howModal").classList.add("hidden"); });

  function escapeHtml(str){
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  connectWS();
  loadHealth();
  loadGeneralNews();
  loadMarketPulse();
  loadLearningImpact();

  setInterval(loadGeneralNews, 90_000);
  setInterval(loadMarketPulse, 25_000);
  setInterval(loadLearningImpact, 60_000);
</script>
</body>
</html>
