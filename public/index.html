<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Trading Arena</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(20,184,166,.18), transparent 55%),
        #060912;
      color:#e5e7eb;
    }
    .glass{
      background: rgba(17,24,39,.58);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 20px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .muted{ color: rgba(229,231,235,.68); }

    .modal-bg{
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(6px);
    }
    .modal{
      background: rgba(17,24,39,.72);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 24px 90px rgba(0,0,0,.60);
      backdrop-filter: blur(18px);
    }

    .pill-good{ background: rgba(16,185,129,.18); border: 1px solid rgba(16,185,129,.25); }
    .pill-bad{ background: rgba(239,68,68,.18); border: 1px solid rgba(239,68,68,.25); }
    .pill-mix{ background: rgba(245,158,11,.18); border: 1px solid rgba(245,158,11,.25); }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-6 py-10">

    <!-- Header -->
    <div class="flex items-start justify-between gap-6">
      <div>
        <h1 class="text-4xl font-bold tracking-tight">AI Trading Arena</h1>
        <p class="mt-2 muted max-w-2xl">
          General news ‚Üí impacted tickers, with audit-grade evidence. This experience is designed to ‚Äúshow the research.‚Äù
        </p>
      </div>
      <div class="flex items-center gap-3">
        <span id="apiChip" class="chip px-3 py-2 rounded-xl text-xs muted">API: ‚Äî</span>
        <span id="wsStatus" class="chip px-3 py-2 rounded-xl text-xs muted">WS: ‚Äî</span>
      </div>
    </div>

    <!-- News Intelligence -->
    <div class="glass mt-8 rounded-2xl p-6">
      <div class="flex items-center justify-between gap-4">
        <div>
          <h2 class="text-xl font-semibold">News Intelligence</h2>
          <p class="text-sm muted mt-1">Click a headline to see impacted US-traded stocks + an Evidence Drawer.</p>
        </div>
        <span id="newsProviderBadge" class="chip px-3 py-1 rounded-lg text-xs muted">Provider: ‚Äî</span>
      </div>

      <div id="newsBox" class="mt-4 space-y-3">
        <div class="muted">Loading‚Ä¶</div>
      </div>
    </div>
  </div>

  <!-- Article -> Impact Modal -->
  <div id="articleModal" class="hidden fixed inset-0 modal-bg">
    <div class="modal max-w-3xl mx-auto mt-14 rounded-3xl overflow-hidden">
      <div class="flex items-start justify-between gap-4 p-5 border-b border-white/10">
        <div>
          <div class="text-xs muted">Article impact research</div>
          <h3 class="text-xl font-semibold mt-1" id="articleTitle">‚Äî</h3>
          <div class="text-xs muted mt-2" id="articleMeta">‚Äî</div>
        </div>
        <button id="closeArticle" class="chip px-3 py-2 rounded-xl hover:opacity-90">‚úï</button>
      </div>

      <div class="p-5">
        <div class="text-sm muted">Likely impacted US-traded companies:</div>
        <div id="impactList" class="mt-3 space-y-2">
          <div class="muted">Loading‚Ä¶</div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-3">
          <div class="text-xs muted" id="impactProvider">‚Äî</div>
          <button id="toggleEvidence" class="chip px-4 py-2 rounded-xl hover:opacity-90 text-sm">
            üîé Evidence Drawer
          </button>
        </div>

        <!-- Evidence Drawer -->
        <div id="evidenceDrawer" class="hidden mt-4 chip rounded-2xl p-4">
          <div class="flex items-start justify-between gap-4">
            <div>
              <div class="text-sm font-semibold">Evidence</div>
              <div class="text-xs muted mt-1">What the system matched, and where the output came from.</div>
            </div>
            <button id="hideEvidence" class="chip px-3 py-2 rounded-xl hover:opacity-90 text-xs">Hide</button>
          </div>

          <div class="mt-4 space-y-3">
            <div>
              <div class="text-xs muted">Provider</div>
              <div id="evidenceProvider" class="text-sm mt-1">‚Äî</div>
            </div>

            <div>
              <div class="text-xs muted">Matched buckets</div>
              <div id="evidenceBuckets" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div>
              <div class="text-xs muted">Matched keywords</div>
              <div id="evidenceKeywords" class="mt-2 flex flex-wrap gap-2"></div>
            </div>

            <div id="aiNotesWrap" class="hidden">
              <div class="text-xs muted">AI notes</div>
              <div id="aiNotes" class="text-sm mt-1 muted">‚Äî</div>
            </div>

            <div class="text-xs muted">
              Governance: Evidence is intentionally displayed so the user can validate plausibility and avoid ‚Äúblack box‚Äù trust.
            </div>
          </div>
        </div>
      </div>

      <div class="p-5 border-t border-white/10 flex items-center justify-end">
        <button id="closeArticle2" class="chip px-4 py-2 rounded-xl hover:opacity-90">Close</button>
      </div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);

function setWsStatus(t){ $("wsStatus").textContent = t; }

async function getJSON(url, opts){
  const r = await fetch(url, opts);
  const t = await r.text();
  return JSON.parse(t);
}

function openArticleModal(){
  $("articleModal").classList.remove("hidden");
  document.body.classList.add("overflow-hidden");
}
function closeArticleModal(){
  $("articleModal").classList.add("hidden");
  document.body.classList.remove("overflow-hidden");
  // reset drawer state
  $("evidenceDrawer").classList.add("hidden");
}
$("closeArticle").addEventListener("click", closeArticleModal);
$("closeArticle2").addEventListener("click", closeArticleModal);
$("articleModal").addEventListener("click", (e) => { if(e.target === $("articleModal")) closeArticleModal(); });

function pillClass(direction){
  if(direction === "benefit") return "pill-good";
  if(direction === "risk") return "pill-bad";
  return "pill-mix";
}

function chipList(el, items){
  el.innerHTML = "";
  const arr = (items || []).slice(0, 40);
  if(!arr.length){
    el.innerHTML = `<span class="muted text-sm">‚Äî</span>`;
    return;
  }
  for(const t of arr){
    const s = document.createElement("span");
    s.className = "chip px-3 py-1 rounded-full text-xs muted";
    s.textContent = t;
    el.appendChild(s);
  }
}

function renderEvidence(evidence){
  if(!evidence){
    $("evidenceProvider").textContent = "‚Äî";
    chipList($("evidenceBuckets"), []);
    chipList($("evidenceKeywords"), []);
    $("aiNotesWrap").classList.add("hidden");
    return;
  }

  // provider can be "heuristic" or "openai"
  if(evidence.provider === "openai"){
    $("evidenceProvider").textContent = "OpenAI (ranked) + Heuristic (audit trail)";
    const h = evidence.heuristicEvidence || {};
    chipList($("evidenceBuckets"), h.matchedBuckets || []);
    chipList($("evidenceKeywords"), h.matchedKeywords || []);
    const notes = evidence.aiEvidence?.notes || "";
    if(notes){
      $("aiNotesWrap").classList.remove("hidden");
      $("aiNotes").textContent = notes;
    } else {
      $("aiNotesWrap").classList.add("hidden");
    }
  } else {
    $("evidenceProvider").textContent = "Heuristic mapping (transparent rules)";
    chipList($("evidenceBuckets"), evidence.matchedBuckets || []);
    chipList($("evidenceKeywords"), evidence.matchedKeywords || []);
    $("aiNotesWrap").classList.add("hidden");
  }
}

$("toggleEvidence").addEventListener("click", () => {
  $("evidenceDrawer").classList.toggle("hidden");
});
$("hideEvidence").addEventListener("click", () => {
  $("evidenceDrawer").classList.add("hidden");
});

async function loadDiagnostics(){
  const health = await getJSON("/api/health");
  $("apiChip").textContent = `API: ${JSON.stringify(health.apis)}`;
}

function renderNews(pack){
  $("newsProviderBadge").textContent = `Provider: ${pack?.provider || "‚Äî"}`;
  const box = $("newsBox");
  const items = pack?.items || [];
  if(!items.length){
    box.innerHTML = `<div class="muted">No headlines available.</div>`;
    return;
  }

  box.innerHTML = items.map((n, idx) => `
    <button data-idx="${idx}" class="w-full text-left chip rounded-2xl p-4 hover:opacity-90">
      <div class="text-sm font-semibold">${n.title || ""}</div>
      <div class="text-xs muted mt-1">${n.source || ""} ‚Ä¢ ${n.publishedAt ? new Date(n.publishedAt).toLocaleString() : ""}</div>
      <div class="text-xs muted mt-2">${n.summary || ""}</div>
      <div class="text-xs muted mt-2">Click to see impacted stocks + evidence ‚Üí</div>
    </button>
  `).join("");

  box.querySelectorAll("button[data-idx]").forEach(btn => {
    btn.addEventListener("click", async () => {
      const i = Number(btn.getAttribute("data-idx"));
      const article = items[i];

      $("articleTitle").textContent = article.title || "Article";
      $("articleMeta").textContent = `${article.source || ""} ‚Ä¢ ${article.publishedAt ? new Date(article.publishedAt).toLocaleString() : ""}`;
      $("impactList").innerHTML = `<div class="muted">Analyzing‚Ä¶</div>`;
      $("impactProvider").textContent = "‚Äî";
      renderEvidence(null);
      openArticleModal();

      try {
        const out = await getJSON("/api/news/impact", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title: article.title || "", summary: article.summary || "" })
        });

        const itemsOut = out.items || [];
        if(!itemsOut.length){
          $("impactList").innerHTML = `<div class="muted">No confident impacted tickers detected for this headline.</div>`;
          $("impactProvider").textContent = `Provider: ${out.evidence?.provider || out.provider || "‚Äî"}`;
          renderEvidence(out.evidence || null);
          return;
        }

        $("impactList").innerHTML = itemsOut.map(x => `
          <div class="chip rounded-2xl p-4">
            <div class="flex items-center justify-between gap-3">
              <div class="font-semibold">${x.ticker} <span class="muted font-normal">‚Ä¢ ${x.company || ""}</span></div>
              <div class="text-xs px-3 py-1 rounded-full ${pillClass(x.direction)}">
                ${(x.direction || "mixed").toUpperCase()} ‚Ä¢ ${(x.horizon || "medium")} ‚Ä¢ ${Number(x.confidence || 0)}%
              </div>
            </div>
            <div class="text-xs muted mt-2">${x.why || ""}</div>
          </div>
        `).join("");

        $("impactProvider").textContent = `Provider: ${out.evidence?.provider || "‚Äî"} ‚Ä¢ Evidence available via drawer.`;
        renderEvidence(out.evidence || null);
      } catch(e){
        $("impactList").innerHTML = `<div class="muted">Impact analysis failed. Check server logs.</div>`;
      }
    });
  });
}

async function loadGeneralNews(){
  const pack = await getJSON("/api/news/general?limit=10");
  renderNews(pack);
}

function connectWS(){
  const proto = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${proto}://${location.host}/ws`);
  ws.onopen = () => setWsStatus("WS: live ‚úÖ");
  ws.onclose = () => setWsStatus("WS: closed ‚ö†Ô∏è");
  ws.onerror = () => setWsStatus("WS: error ‚ö†Ô∏è");
  return ws;
}

(async function init(){
  await loadDiagnostics().catch(()=>{});
  await loadGeneralNews().catch(()=>{});
  connectWS();
  setInterval(() => loadGeneralNews().catch(()=>{}), 90000);
})();
</script>
</body>
</html>
