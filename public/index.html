<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Trading Arena</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(20,184,166,.22), transparent 55%),
        #070b1a;
      color:#e5e7eb;
    }
    .glass{
      background: rgba(17,24,39,.58);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:0 20px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(16px);
    }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .muted{ color: rgba(229,231,235,.7); }
    .badge-real{
      background: linear-gradient(135deg,#22c55e,#16a34a);
      color:#021b0d;
    }
    .badge-mock{
      background: linear-gradient(135deg,#f97316,#ef4444);
      color:#220900;
    }
  </style>
</head>

<body class="min-h-screen">
<div class="max-w-6xl mx-auto px-6 py-10">

  <!-- Header -->
  <div class="flex items-start justify-between gap-6">
    <div>
      <h1 class="text-4xl font-bold tracking-tight">
        AI Trading Arena
      </h1>
      <p class="mt-2 muted max-w-2xl">
        Autonomous trading intelligence. Four AI bots compete continuously using live markets, news, and persistent learning.
      </p>
    </div>

    <div class="flex items-center gap-3">
      <a href="/war-room.html" class="chip px-4 py-2 rounded-xl hover:opacity-90">
        ⚔️ War Room
      </a>
      <span id="wsStatus" class="chip px-4 py-2 rounded-xl text-xs muted">
        WS: connecting…
      </span>
    </div>
  </div>

  <!-- Live Status Bar -->
  <div class="glass rounded-2xl p-5 mt-8">
    <div class="flex flex-wrap gap-3 items-center">
      <span class="chip px-3 py-2 rounded-xl text-xs muted" id="marketChip">Market: —</span>
      <span class="chip px-3 py-2 rounded-xl text-xs muted" id="runnerChip">Runner: —</span>
      <span class="chip px-3 py-2 rounded-xl text-xs muted">
        Symbol: <b id="liveSymbol">—</b>
      </span>
      <span class="chip px-3 py-2 rounded-xl text-xs muted">
        Last event: <span id="lastEvent">—</span>
      </span>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="grid lg:grid-cols-12 gap-6 mt-8">

    <!-- Left -->
    <div class="lg:col-span-7 glass rounded-2xl p-6">
      <h2 class="text-xl font-semibold">Current Intelligence Snapshot</h2>

      <div class="grid sm:grid-cols-3 gap-4 mt-5">
        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">Price</div>
          <div id="priceBox" class="text-2xl font-bold mt-1">—</div>
        </div>
        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">Change %</div>
          <div id="chgBox" class="text-2xl font-bold mt-1">—</div>
        </div>
        <div class="chip rounded-2xl p-4">
          <div class="text-xs muted">Avg news sentiment</div>
          <div id="sentBox" class="text-2xl font-bold mt-1">—</div>
        </div>
      </div>

      <div class="mt-5 chip rounded-2xl p-4">
        <div class="text-xs muted">Leading bot (highest conviction)</div>
        <div id="winnerBox" class="text-lg font-semibold mt-1">—</div>
        <div id="marketNote" class="text-xs muted mt-2">—</div>
      </div>

      <div class="mt-6">
        <h3 class="font-semibold">Bots (live)</h3>
        <div id="botsList" class="mt-3 grid sm:grid-cols-2 gap-3">
          <div class="muted">Waiting for runner…</div>
        </div>
      </div>
    </div>

    <!-- Right -->
    <div class="lg:col-span-5 glass rounded-2xl p-6">
      <h2 class="text-xl font-semibold">Live News Intelligence</h2>
      <p class="text-sm muted mt-1">
        Articles are continuously refreshed and bound to the active symbol.
      </p>

      <div id="newsBox" class="mt-4 space-y-3">
        <div class="muted">—</div>
      </div>
    </div>
  </div>

</div>

<script>
const $ = id => document.getElementById(id);

let currentSymbol = null;
let ws = null;

function setWS(text){
  $("wsStatus").textContent = text;
}

function providerBadge(provider){
  if(provider === "mock"){
    return '<span class="badge-mock px-2 py-1 rounded-lg text-xs font-semibold">MOCK</span>';
  }
  return `<span class="badge-real px-2 py-1 rounded-lg text-xs font-semibold">${provider.toUpperCase()}</span>`;
}

function renderBots(bots){
  const box = $("botsList");
  box.innerHTML = "";
  bots.forEach(b => {
    const el = document.createElement("div");
    el.className = "chip rounded-2xl p-4";
    el.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-semibold">${b.label}</div>
        <div class="text-xs muted">${b.horizon}</div>
      </div>
      <div class="mt-2 text-sm">
        <b>${b.signal}</b> • conf ${b.confidence}
      </div>
      <div class="mt-2 text-xs muted">${b.rationale || ""}</div>
    `;
    box.appendChild(el);
  });
}

function renderNews(pack){
  const box = $("newsBox");
  const items = pack.items || [];
  if(!items.length){
    box.innerHTML = `<div class="muted">No news</div>`;
    return;
  }

  box.innerHTML = items.map(n => `
    <div class="chip rounded-2xl p-4">
      <div class="flex items-center justify-between gap-3">
        <div class="text-sm font-semibold">${(n.title||"").slice(0,140)}</div>
        ${providerBadge(pack.provider)}
      </div>
      <div class="text-xs muted mt-1">
        ${n.source || ""} • ${n.publishedAt ? new Date(n.publishedAt).toLocaleString() : ""}
      </div>
      <div class="text-xs muted mt-2">${(n.summary||"").slice(0,160)}</div>
    </div>
  `).join("");
}

async function fetchSnapshot(symbol){
  const res = await fetch(`/api/bots/${symbol}`);
  const data = await res.json();

  $("winnerBox").textContent = data.winner || "—";
  $("marketNote").textContent =
    `Market: ${data.market.open ? "OPEN" : "CLOSED"} (${data.market.reason}) • Trades allowed: ${data.tradesAllowed ? "YES" : "NO"}`;

  const f = data.features || {};
  $("priceBox").textContent = f.price ? `$${Number(f.price).toFixed(2)}` : "—";
  $("chgBox").textContent = f.changePercent !== undefined ? `${Number(f.changePercent).toFixed(2)}%` : "—";
  $("sentBox").textContent = f.avgSent !== undefined ? Number(f.avgSent).toFixed(2) : "—";

  renderBots(data.bots || []);

  const news = await fetch(`/api/news/${symbol}`).then(r=>r.json());
  renderNews(news);
}

function connectWS(){
  const proto = location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${proto}://${location.host}/ws`);

  ws.onopen = () => setWS("WS: live ✅");
  ws.onclose = () => setWS("WS: closed ⚠️");
  ws.onerror = () => setWS("WS: error ⚠️");

  ws.onmessage = async ev => {
    const msg = JSON.parse(ev.data);
    $("lastEvent").textContent = msg.type;

    if(msg.type === "carousel_tick"){
      currentSymbol = msg.payload.symbol;
      $("liveSymbol").textContent = currentSymbol;
      $("marketChip").textContent =
        `Market: ${msg.payload.market.open ? "OPEN" : "CLOSED"} (${msg.payload.market.reason})`;
      await fetchSnapshot(currentSymbol);
    }

    if(msg.type === "bot_fight"){
      await fetchSnapshot(msg.payload.symbol);
    }
  };
}

(async function init(){
  const runner = await fetch("/api/runner/status").then(r=>r.json());
  $("runnerChip").textContent = `Runner: ${runner.enabled ? "ON" : "OFF"} (${runner.intervalSec}s)`;
  connectWS();
})();
</script>
</body>
</html>
