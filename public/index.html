<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Trading Arena</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{
      background: radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,.25), transparent 60%),
                  radial-gradient(900px 600px at 80% 60%, rgba(20,184,166,.20), transparent 55%),
                  #070b1a;
      color: #e5e7eb;
    }
    .glass{
      background: rgba(17,24,39,.55);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 18px 70px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .muted{ color: rgba(229,231,235,.72); }
    .chip{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }
    .btn{
      background: linear-gradient(135deg, rgba(99,102,241,.95), rgba(168,85,247,.90));
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-6 py-10">
    <div class="flex items-start justify-between gap-6">
      <div>
        <h1 class="text-4xl font-bold tracking-tight">AI Trading Arena</h1>
        <p class="mt-2 muted max-w-2xl">
          Four bots compete with real market data. Each starts with <b>$100,000</b> and aims for <b>$150,000</b>.
          You can type <b>any ticker</b> (all stocks are open).
        </p>
      </div>

      <div class="flex items-center gap-3">
        <a href="/war-room.html" class="chip px-4 py-2 rounded-xl hover:opacity-90">
          ⚔️ War Room
        </a>
        <a href="/api/health" target="_blank" class="chip px-4 py-2 rounded-xl hover:opacity-90">
          API Health
        </a>
      </div>
    </div>

    <!-- Controls -->
    <div class="glass mt-8 rounded-2xl p-5">
      <div class="grid md:grid-cols-12 gap-4 items-end">
        <div class="md:col-span-4">
          <label class="text-sm muted">Stock symbol (any ticker)</label>
          <input id="symbolInput" class="mt-2 w-full rounded-xl px-4 py-3 bg-slate-900/60 border border-white/10 outline-none"
                 value="AAPL" />
        </div>

        <div class="md:col-span-4">
          <label class="text-sm muted">Learning speed</label>
          <select id="speedSelect" class="mt-2 w-full rounded-xl px-4 py-3 bg-slate-900/60 border border-white/10 outline-none">
            <option value="realtime">Real-time (production)</option>
            <option value="accelerated">Accelerated (fast feedback)</option>
          </select>
          <p class="text-xs muted mt-2">Controls how quickly predictions get evaluated as correct/incorrect.</p>
        </div>

        <div class="md:col-span-4 flex gap-3">
          <button id="runBtn" class="btn w-full rounded-xl px-5 py-3 font-semibold hover:opacity-95">
            Run “Bots Fight”
          </button>
          <button id="refreshBtn" class="chip w-full rounded-xl px-5 py-3 font-semibold hover:opacity-95">
            Refresh
          </button>
        </div>
      </div>

      <div id="topError" class="hidden mt-4 rounded-xl border border-red-500/30 bg-red-500/10 px-4 py-3 text-sm"></div>
    </div>

    <!-- Main grid -->
    <div class="grid lg:grid-cols-12 gap-6 mt-8">
      <div class="lg:col-span-7 glass rounded-2xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Fight Results</h2>
          <span class="chip px-3 py-1 rounded-lg text-xs muted">4 bots • real-time ledger</span>
        </div>
        <p class="text-sm muted mt-1">Signals + bankroll progress toward $150k</p>

        <div class="grid sm:grid-cols-3 gap-4 mt-5">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Price</div>
            <div id="priceBox" class="text-2xl font-bold mt-1">—</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Change %</div>
            <div id="chgBox" class="text-2xl font-bold mt-1">—</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Avg news sentiment</div>
            <div id="sentBox" class="text-2xl font-bold mt-1">—</div>
          </div>
        </div>

        <div class="mt-4 chip rounded-2xl p-4">
          <div class="text-xs muted">Winner (highest confidence)</div>
          <div id="winnerBox" class="text-lg font-semibold mt-1">—</div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold">Bots (4)</h3>
          <div id="botsList" class="mt-3 grid sm:grid-cols-2 gap-3"></div>
        </div>

        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Trade Ledger (Most Recent)</h3>
            <span class="text-xs muted">Shows BUY/SELL + bot rationale</span>
          </div>
          <div class="mt-3 overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="muted">
                <tr class="text-left">
                  <th class="py-2 pr-3">Time</th>
                  <th class="py-2 pr-3">Bot</th>
                  <th class="py-2 pr-3">Side</th>
                  <th class="py-2 pr-3">Symbol</th>
                  <th class="py-2 pr-3">Qty</th>
                  <th class="py-2 pr-3">Price</th>
                  <th class="py-2">Why</th>
                </tr>
              </thead>
              <tbody id="tradesTbody">
                <tr class="muted"><td class="py-3" colspan="7">—</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="lg:col-span-5 glass rounded-2xl p-6">
        <h2 class="text-xl font-semibold">Latest News (Top 8)</h2>
        <p class="text-sm muted mt-1">Used for sentiment features + learning evaluation context</p>
        <div id="newsBox" class="mt-4 space-y-3">
          <div class="muted">—</div>
        </div>
      </div>
    </div>

    <!-- Learning impact -->
    <div class="glass rounded-2xl p-6 mt-8">
      <div class="flex items-center justify-between">
        <h2 class="text-xl font-semibold">Learning impact over time</h2>
        <span class="chip px-3 py-1 rounded-lg text-xs muted">Accuracy % by bot strategy</span>
      </div>
      <div class="mt-4">
        <canvas id="impactChart" height="120"></canvas>
      </div>
    </div>

    <!-- Diagnostics -->
    <div class="glass rounded-2xl p-6 mt-8">
      <h2 class="text-xl font-semibold">Diagnostics</h2>
      <p class="text-sm muted mt-1">Useful to confirm services and settings</p>
      <div class="mt-4 flex flex-wrap gap-3">
        <span id="apiChip" class="chip px-3 py-2 rounded-xl text-xs muted">API: —</span>
        <span id="verChip" class="chip px-3 py-2 rounded-xl text-xs muted">Version: —</span>
        <span id="speedChip" class="chip px-3 py-2 rounded-xl text-xs muted">Learning speed: —</span>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  let chart = null;

  function showError(msg){
    const el = $("topError");
    el.textContent = msg;
    el.classList.remove("hidden");
  }
  function clearError(){
    $("topError").classList.add("hidden");
    $("topError").textContent = "";
  }

  async function getJSON(url, opts){
    const r = await fetch(url, opts);
    const txt = await r.text();
    try { return JSON.parse(txt); }
    catch(e){ throw new Error(`API returned non-JSON. Check server route: ${url}`); }
  }

  function renderBots(bots){
    const box = $("botsList");
    box.innerHTML = "";
    for(const b of bots){
      const div = document.createElement("div");
      div.className = "chip rounded-2xl p-4";
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-semibold">${b.label || b.strategy}</div>
          <div class="text-xs muted">${b.horizon}</div>
        </div>
        <div class="mt-2 text-sm">
          <span class="font-semibold">${b.signal}</span>
          <span class="muted">• conf ${b.confidence ?? b.baseConfidence}</span>
        </div>
        <div class="mt-2 text-xs muted">${b.rationale || ""}</div>
      `;
      box.appendChild(div);
    }
  }

  function renderTrades(items){
    const tb = $("tradesTbody");
    if(!items || !items.length){
      tb.innerHTML = `<tr class="muted"><td class="py-3" colspan="7">—</td></tr>`;
      return;
    }
    tb.innerHTML = items.map(t => `
      <tr class="border-t border-white/5">
        <td class="py-2 pr-3 muted">${new Date(t.ts).toLocaleString()}</td>
        <td class="py-2 pr-3">${t.bot}</td>
        <td class="py-2 pr-3">${t.side}</td>
        <td class="py-2 pr-3">${t.symbol}</td>
        <td class="py-2 pr-3">${Number(t.qty || 0).toFixed(3)}</td>
        <td class="py-2 pr-3">$${Number(t.price || 0).toFixed(2)}</td>
        <td class="py-2 muted">${t.rationale || ""}</td>
      </tr>
    `).join("");
  }

  function renderNews(pack){
    const box = $("newsBox");
    const items = pack?.items || [];
    if(!items.length){
      box.innerHTML = `<div class="muted">—</div>`;
      return;
    }
    box.innerHTML = items.map(n => `
      <a class="block chip rounded-2xl p-4 hover:opacity-95" href="${n.url || "#"}" target="_blank">
        <div class="text-sm font-semibold">${(n.title || "").slice(0, 140)}</div>
        <div class="text-xs muted mt-1">${n.source || ""} • ${n.publishedAt ? new Date(n.publishedAt).toLocaleString() : ""}</div>
        <div class="text-xs muted mt-2">${(n.summary || "").slice(0, 160)}</div>
      </a>
    `).join("");
  }

  function renderImpactChart(byStrategy){
    const strategies = Object.keys(byStrategy || {});
    if(!strategies.length) return;

    // Build unified x-axis (days)
    const daySet = new Set();
    strategies.forEach(s => (byStrategy[s] || []).forEach(p => daySet.add(p.day)));
    const days = Array.from(daySet).sort();

    const datasets = strategies.map(s => {
      const map = new Map((byStrategy[s] || []).map(p => [p.day, p.accuracy]));
      return {
        label: s,
        data: days.map(d => map.has(d) ? map.get(d) : null),
        spanGaps: true,
        tension: 0.25
      };
    });

    const ctx = $("impactChart").getContext("2d");
    if(chart) chart.destroy();
    chart = new Chart(ctx, {
      type: "line",
      data: { labels: days, datasets },
      options: {
        responsive: true,
        plugins: {
          legend: { labels: { color: "rgba(229,231,235,.8)" } }
        },
        scales: {
          x: { ticks: { color: "rgba(229,231,235,.6)" }, grid: { color: "rgba(255,255,255,.06)" } },
          y: { ticks: { color: "rgba(229,231,235,.6)" }, grid: { color: "rgba(255,255,255,.06)" }, suggestedMin: 0, suggestedMax: 100 }
        }
      }
    });
  }

  async function loadDiagnostics(){
    const health = await getJSON("/api/health");
    $("apiChip").textContent = `API: ${JSON.stringify(health.apis)}`;
    $("verChip").textContent = `Version: ${health.version}`;

    const speed = await getJSON("/api/settings/learning-speed");
    $("speedChip").textContent = `Learning speed: ${speed.mode} (${speed.evalAfterSec}s)`;

    // Sync dropdown to server state
    $("speedSelect").value = speed.mode === "accelerated" ? "accelerated" : "realtime";
  }

  async function loadImpact(){
    const impact = await getJSON("/api/learning/impact?days=14");
    renderImpactChart(impact.byStrategy);
  }

  async function loadTrades(){
    const t = await getJSON("/api/trades/recent?limit=25");
    renderTrades(t.items || []);
  }

  async function runBots(){
    clearError();
    const symbol = $("symbolInput").value.trim().toUpperCase() || "AAPL";

    $("winnerBox").textContent = "Running…";
    $("priceBox").textContent = "—";
    $("chgBox").textContent = "—";
    $("sentBox").textContent = "—";

    const result = await getJSON(`/api/bots/${encodeURIComponent(symbol)}`);
    $("winnerBox").textContent = result.winner || "—";

    const f = result.features || {};
    $("priceBox").textContent = f.price ? `$${Number(f.price).toFixed(2)}` : "—";
    $("chgBox").textContent = (f.changePercent !== undefined) ? `${Number(f.changePercent).toFixed(2)}%` : "—";
    $("sentBox").textContent = (f.avgSent !== undefined) ? `${Number(f.avgSent).toFixed(2)}` : "—";

    // enrich 4 bots with labels if not present
    const labelMap = {
      sp500_long: "S&P500 Long",
      market_swing: "Market Swing",
      day_trade: "Day Trade",
      news_only: "News-Only"
    };
    const bots = (result.bots || []).map(b => ({ ...b, label: labelMap[b.strategy] || b.strategy }));
    renderBots(bots);

    const news = await getJSON(`/api/news/${encodeURIComponent(symbol)}`);
    renderNews(news);

    await loadTrades();
    await loadImpact();
  }

  async function setSpeed(){
    clearError();
    const mode = $("speedSelect").value === "accelerated" ? "accelerated" : "realtime";
    const payload = mode === "accelerated"
      ? { mode: "accelerated", evalAfterSec: 30 }
      : { mode: "realtime", evalAfterSec: 3600 };

    await getJSON("/api/settings/learning-speed", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    await loadDiagnostics();
    await loadImpact();
  }

  $("runBtn").addEventListener("click", () => runBots().catch(e => showError(e.message)));
  $("refreshBtn").addEventListener("click", async () => {
    try {
      clearError();
      await loadDiagnostics();
      await loadTrades();
      await loadImpact();
    } catch(e){
      showError(e.message);
    }
  });
  $("speedSelect").addEventListener("change", () => setSpeed().catch(e => showError(e.message)));

  (async function init(){
    try{
      await loadDiagnostics();
      await loadTrades();
      await loadImpact();
    }catch(e){
      showError(e.message);
    }
  })();
</script>

</body>
</html>
