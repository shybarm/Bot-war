<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AI Trading Arena</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(20,184,166,.18), transparent 55%),
        #060912;
      color:#e5e7eb;
    }
    .glass{
      background: rgba(17,24,39,.58);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 20px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .muted{ color: rgba(229,231,235,.68); }

    .modalScrim{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding: 18px;
      z-index: 80;
    }
    .modal{
      width: min(980px, 96vw);
      border-radius: 18px;
      max-height: 85vh;
      overflow:auto;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-6 py-8">

    <!-- TOP COMMAND BAR (NAV) -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
      <div>
        <div class="text-4xl font-semibold tracking-tight">AI Trading Arena</div>
        <div class="muted mt-1">
          General news → impacted tickers, with audit-grade evidence. This experience is designed to “show the research.”
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2 justify-start sm:justify-end">
        <a href="/war-room.html"
           class="chip px-4 py-2 rounded-xl hover:opacity-90 transition"
           title="Open the live command center">
          ⚔️ War Room
        </a>

        <button id="btnRunner"
                class="chip px-4 py-2 rounded-xl hover:opacity-90 transition"
                title="View runner + market mode">
          Runner Status
        </button>

        <button id="btnHow"
                class="chip px-4 py-2 rounded-xl hover:opacity-90 transition"
                title="Explain this system">
          How it works
        </button>

        <div id="apiChip" class="chip px-4 py-2 rounded-xl text-xs whitespace-nowrap">
          API: <span class="kbd" id="apiJson">{}</span>
        </div>

        <div id="wsBadge" class="chip px-3 py-2 rounded-xl text-xs flex items-center gap-2 whitespace-nowrap">
          <span id="wsText">WS: connecting…</span>
          <span id="wsDot" class="w-2.5 h-2.5 rounded-full bg-amber-400"></span>
        </div>
      </div>
    </div>

    <!-- MAIN CARD -->
    <div class="glass rounded-2xl mt-8 p-6">
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="text-xl font-semibold">News Intelligence</div>
          <div class="muted text-sm mt-1">
            Click a headline to see impacted US-traded stocks + an Evidence Drawer.
          </div>
        </div>
        <div class="chip text-xs px-3 py-2 rounded-xl whitespace-nowrap">
          <span id="providerPill">Provider: —</span>
        </div>
      </div>

      <div class="mt-5">
        <div id="generalNews" class="space-y-3">
          <div class="chip rounded-xl p-4">
            <div class="text-sm font-semibold">Loading news…</div>
            <div class="muted text-xs mt-1">If this stays empty, check /api/health and your NEWS keys.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- EVIDENCE DRAWER (simple modal) -->
    <div id="evidenceModal" class="modalScrim">
      <div class="glass modal p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-semibold">Evidence Drawer</div>
            <div class="muted text-sm mt-1">Why this article maps to these tickers (human-readable chain).</div>
          </div>
          <button class="chip px-3 py-2 rounded-xl hover:opacity-90" data-close="evidenceModal">Close</button>
        </div>

        <div class="mt-5">
          <div class="chip rounded-xl p-4">
            <div class="text-sm font-semibold" id="eTitle">—</div>
            <div class="muted text-xs mt-1" id="eMeta">—</div>
            <div class="mt-3 text-sm" id="eSummary">—</div>
          </div>

          <div class="mt-4">
            <div class="text-sm font-semibold">Impacted tickers</div>
            <div class="muted text-xs mt-1">Ranked list + confidence, with “why”.</div>
            <div id="impactList" class="mt-3 space-y-2"></div>
          </div>

          <div class="mt-5">
            <div class="text-sm font-semibold">Evidence signals</div>
            <div class="muted text-xs mt-1">What the system matched (AI if available, heuristic fallback otherwise).</div>
            <div id="evidenceSignals" class="mt-3 chip rounded-xl p-4 text-sm"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- RUNNER STATUS MODAL -->
    <div id="runnerModal" class="modalScrim">
      <div class="glass modal p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-semibold">Runner Status</div>
            <div class="muted text-sm mt-1">Operational posture, market gate, and scan parameters.</div>
          </div>
          <button class="chip px-3 py-2 rounded-xl hover:opacity-90" data-close="runnerModal">Close</button>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="chip rounded-xl p-4">
            <div class="text-sm font-semibold">Market</div>
            <div class="muted text-xs mt-1" id="rmMarket">—</div>
          </div>
          <div class="chip rounded-xl p-4">
            <div class="text-sm font-semibold">Runner</div>
            <div class="muted text-xs mt-1" id="rmRunner">—</div>
          </div>
          <div class="chip rounded-xl p-4 md:col-span-2">
            <div class="text-sm font-semibold">State</div>
            <pre class="muted text-xs mt-2 whitespace-pre-wrap" id="rmState">{}</pre>
          </div>
        </div>
      </div>
    </div>

    <!-- HOW IT WORKS MODAL -->
    <div id="howModal" class="modalScrim">
      <div class="glass modal p-6">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-xl font-semibold">How This System Works</div>
            <div class="muted text-sm mt-1">Observe → Decide → Act → Learn → Repeat (always-on).</div>
          </div>
          <button class="chip px-3 py-2 rounded-xl hover:opacity-90" data-close="howModal">Close</button>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-5 gap-3">
          <div class="chip rounded-xl p-4 md:col-span-2">
            <div class="text-sm font-semibold">1) Observe</div>
            <div class="muted text-xs mt-1">Pull price + general news; attach sentiment + signals.</div>
          </div>
          <div class="chip rounded-xl p-4 md:col-span-2">
            <div class="text-sm font-semibold">2) Decide</div>
            <div class="muted text-xs mt-1">Each bot outputs BUY/SELL/HOLD with a rationale + confidence.</div>
          </div>
          <div class="chip rounded-xl p-4">
            <div class="text-sm font-semibold">3) Act</div>
            <div class="muted text-xs mt-1">Market open: real trades. Closed: simulation + learning.</div>
          </div>

          <div class="chip rounded-xl p-4 md:col-span-2">
            <div class="text-sm font-semibold">4) Learn</div>
            <div class="muted text-xs mt-1">
              After a horizon, outcomes are graded WIN/LOSS and update shared weights.
            </div>
          </div>
          <div class="chip rounded-xl p-4 md:col-span-3">
            <div class="text-sm font-semibold">5) Repeat (autonomous)</div>
            <div class="muted text-xs mt-1">
              The runner rotates symbols continuously and persists state so redeploys resume smoothly.
            </div>
          </div>
        </div>

        <div class="mt-4 chip rounded-xl p-4">
          <div class="text-sm font-semibold">Where to see “the research”</div>
          <div class="muted text-sm mt-1">
            Open <span class="kbd">War Room</span> to see the event stream, bot reasoning, trade history,
            and learning verdicts over time.
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
  const $ = (id) => document.getElementById(id);

  function show(id){ $(id).style.display = "flex"; }
  function hide(id){ $(id).style.display = "none"; }

  // Close modals via [data-close]
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-close]");
    if (!btn) return;
    hide(btn.getAttribute("data-close"));
  });
  // Close modal if clicking scrim
  document.querySelectorAll(".modalScrim").forEach(scrim => {
    scrim.addEventListener("click", (e) => {
      if (e.target === scrim) scrim.style.display = "none";
    });
  });

  // Buttons
  $("btnRunner").addEventListener("click", async () => {
    show("runnerModal");
    $("rmMarket").textContent = "Loading…";
    $("rmRunner").textContent = "Loading…";
    $("rmState").textContent = "{}";
    try{
      const r = await fetch("/api/runner/status");
      const j = await r.json();
      $("rmMarket").textContent = `${j.market?.open ? "Open" : "Closed"} • ${j.market?.reason || "—"} • TZ: ${j.market?.tz || "—"}`;
      $("rmRunner").textContent =
        `enabled=${j.enabled} • intervalSec=${j.intervalSec} • scanBatch=${j.scanBatch} • tradeTop=${j.tradeTop}`;
      $("rmState").textContent = JSON.stringify(j, null, 2);
    } catch(e){
      $("rmMarket").textContent = "Runner status unavailable (check server logs).";
      $("rmRunner").textContent = "—";
    }
  });

  $("btnHow").addEventListener("click", () => show("howModal"));

  function setWsStatus(text, ok){
    $("wsText").textContent = text;
    $("wsDot").className = "w-2.5 h-2.5 rounded-full " + (ok ? "bg-emerald-400" : "bg-amber-400");
  }

  async function loadDiagnostics(){
    try{
      const r = await fetch("/api/health");
      const j = await r.json();
      $("apiJson").textContent = JSON.stringify(j.apis || {});
    } catch {}
  }

  function renderEvidence(evidence){
    if(!evidence){
      $("evidenceSignals").textContent = "No evidence payload available.";
      return;
    }
    const lines = [];
    if(evidence.provider) lines.push(`Provider: ${evidence.provider}`);
    if(evidence.aiEvidence){
      const kw = (evidence.aiEvidence.keywords || []).slice(0, 14);
      lines.push(`AI keywords: ${kw.join(", ") || "—"}`);
      if(evidence.aiEvidence.notes) lines.push(`AI notes: ${evidence.aiEvidence.notes}`);
    }
    if(evidence.heuristicEvidence){
      const he = evidence.heuristicEvidence;
      if(Array.isArray(he.matchedBuckets) && he.matchedBuckets.length){
        lines.push(`Heuristic buckets: ${he.matchedBuckets.join(" • ")}`);
      }
      if(Array.isArray(he.matchedKeywords) && he.matchedKeywords.length){
        lines.push(`Heuristic keywords: ${he.matchedKeywords.slice(0, 18).join(", ")}`);
      }
    } else if (Array.isArray(evidence.matchedBuckets)) {
      // legacy heuristic payload
      if(evidence.matchedBuckets.length) lines.push(`Buckets: ${evidence.matchedBuckets.join(" • ")}`);
      if(Array.isArray(evidence.matchedKeywords) && evidence.matchedKeywords.length)
        lines.push(`Keywords: ${evidence.matchedKeywords.slice(0, 18).join(", ")}`);
    }
    $("evidenceSignals").textContent = lines.join("\n");
  }

  async function loadGeneralNews(){
    const wrap = $("generalNews");
    wrap.innerHTML = `<div class="chip rounded-xl p-4"><div class="text-sm font-semibold">Loading…</div></div>`;

    let pack = null;
    try{
      const r = await fetch("/api/news/general?limit=10");
      pack = await r.json();
    } catch(e){
      pack = { provider:"error", items: [] };
    }

    const provider = pack?.provider || "—";
    $("providerPill").textContent = `Provider: ${provider}`;

    const items = Array.isArray(pack?.items) ? pack.items : [];
    if(!items.length){
      wrap.innerHTML = `
        <div class="chip rounded-xl p-4">
          <div class="text-sm font-semibold">No general news available</div>
          <div class="muted text-xs mt-1">Configure NEWS keys or fallback will populate.</div>
        </div>
      `;
      return;
    }

    wrap.innerHTML = items.map((a, idx) => {
      const title = a.title || "Untitled";
      const source = a.source || provider || "—";
      const publishedAt = a.publishedAt ? new Date(a.publishedAt).toLocaleString() : "";
      const summary = a.summary || "";

      return `
        <button class="chip w-full text-left rounded-xl p-4 hover:opacity-90 transition"
                data-article="${idx}">
          <div class="flex items-start justify-between gap-3">
            <div class="text-sm font-semibold">${title}</div>
            <div class="muted text-xs whitespace-nowrap">${source}</div>
          </div>
          <div class="muted text-xs mt-1">${publishedAt}</div>
          <div class="muted text-sm mt-2 line-clamp-2">${summary}</div>
          <div class="muted text-xs mt-2">Click to see impacted stocks + evidence →</div>
        </button>
      `;
    }).join("");

    // click handlers: open evidence drawer + fetch /api/news/impact
    wrap.querySelectorAll("[data-article]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const idx = Number(btn.getAttribute("data-article"));
        const a = items[idx];

        $("eTitle").textContent = a.title || "—";
        $("eMeta").textContent = `${a.source || provider || "—"} • ${a.publishedAt ? new Date(a.publishedAt).toLocaleString() : ""}`;
        $("eSummary").textContent = a.summary || "—";
        $("impactList").innerHTML = `<div class="muted text-sm">Analyzing impact…</div>`;
        $("evidenceSignals").textContent = "Loading evidence…";
        show("evidenceModal");

        try{
          const r = await fetch("/api/news/impact", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ title: a.title || "", summary: a.summary || "" })
          });
          const out = await r.json();
          const list = Array.isArray(out?.items) ? out.items : [];

          if(!list.length){
            $("impactList").innerHTML = `<div class="muted text-sm">No impacted tickers detected for this article (yet).</div>`;
          } else {
            $("impactList").innerHTML = list.map(x => `
              <div class="chip rounded-xl p-3">
                <div class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-semibold">${(x.ticker || "—").toUpperCase()}</div>
                    <div class="muted text-xs mt-0.5">${x.company || ""}</div>
                  </div>
                  <div class="muted text-xs text-right">
                    ${(x.direction || "mixed").toUpperCase()} • ${(x.horizon || "medium")} • ${Number(x.confidence || 0)}%
                  </div>
                </div>
                <div class="muted text-xs mt-2">${x.why || ""}</div>
              </div>
            `).join("");
          }

          renderEvidence(out?.evidence || null);
        } catch(e){
          $("impactList").innerHTML = `<div class="muted text-sm">Impact analysis failed. Check server logs.</div>`;
          $("evidenceSignals").textContent = "—";
        }
      });
    });
  }

  function connectWS(){
    let ws;
    try{
      const url = (location.protocol === "https:" ? "wss://" : "ws://") + location.host;
      ws = new WebSocket(url);
    } catch(e){
      setWsStatus("WS: unsupported", false);
      return null;
    }

    ws.onopen = () => setWsStatus("WS: live", true);
    ws.onclose = () => setWsStatus("WS: closed ⚠️", false);
    ws.onerror = () => setWsStatus("WS: error ⚠️", false);
    return ws;
  }

  (async function init(){
    await loadDiagnostics().catch(()=>{});
    await loadGeneralNews().catch(()=>{});
    connectWS();
    setInterval(() => loadGeneralNews().catch(()=>{}), 90000);
  })();
</script>
</body>
</html>
