<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Trading Arena</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(900px 600px at 80% 60%, rgba(20,184,166,.18), transparent 55%),
        #060912;
      color:#e5e7eb;
    }
    .glass{
      background: rgba(17,24,39,.58);
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 20px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
    }
    .chip{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
    }
    .muted{ color: rgba(229,231,235,.68); }
    .badge-real{
      background: linear-gradient(135deg, rgba(16,185,129,.9), rgba(5,150,105,.85));
    }
    .badge-mock{
      background: linear-gradient(135deg, rgba(239,68,68,.9), rgba(220,38,38,.85));
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-6xl mx-auto px-6 py-10">

    <!-- Header -->
    <div class="flex items-start justify-between gap-6">
      <div>
        <h1 class="text-4xl font-bold tracking-tight">AI Trading Arena</h1>
        <p class="mt-2 muted max-w-2xl">
          Autonomous trading intelligence. Four bots. Continuous learning.
          <span class="block mt-1">System operates continuously during market hours.</span>
        </p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/war-room.html" class="chip px-4 py-2 rounded-xl hover:opacity-90">⚔️ War Room</a>
        <span id="wsStatus" class="chip px-3 py-2 rounded-xl text-xs muted">WS: connecting…</span>
      </div>
    </div>

    <!-- LIVE STATUS BAR -->
    <div class="glass mt-8 rounded-2xl p-5">
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <div class="text-xs muted">Current Symbol</div>
          <div id="liveSymbol" class="text-2xl font-bold mt-1">—</div>
        </div>
        <div>
          <div class="text-xs muted">Market State</div>
          <div id="marketState" class="text-lg font-semibold mt-1">—</div>
        </div>
        <div>
          <div class="text-xs muted">Last Event</div>
          <div id="lastEvent" class="text-sm mt-2 muted">—</div>
        </div>
        <div>
          <div class="text-xs muted">Mode</div>
          <div class="text-lg font-semibold mt-1">Live Autonomous</div>
        </div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="grid lg:grid-cols-12 gap-6 mt-8">

      <!-- LEFT: BOT DECISIONS -->
      <div class="lg:col-span-7 glass rounded-2xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Latest Bot Decisions</h2>
          <span class="chip px-3 py-1 rounded-lg text-xs muted">Auto-updated</span>
        </div>

        <div class="grid sm:grid-cols-3 gap-4 mt-5">
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Price</div>
            <div id="priceBox" class="text-2xl font-bold mt-1">—</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Change %</div>
            <div id="chgBox" class="text-2xl font-bold mt-1">—</div>
          </div>
          <div class="chip rounded-2xl p-4">
            <div class="text-xs muted">Avg News Sentiment</div>
            <div id="sentBox" class="text-2xl font-bold mt-1">—</div>
          </div>
        </div>

        <div class="mt-5 chip rounded-2xl p-4">
          <div class="text-xs muted">Winning Strategy</div>
          <div id="winnerBox" class="text-lg font-semibold mt-1">—</div>
          <div id="marketDetail" class="text-xs muted mt-2">—</div>
        </div>

        <div class="mt-6">
          <h3 class="font-semibold">Bot Signals</h3>
          <div id="botsList" class="mt-3 grid sm:grid-cols-2 gap-3"></div>
        </div>
      </div>

      <!-- RIGHT: NEWS -->
      <div class="lg:col-span-5 glass rounded-2xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-semibold">Live News Impact</h2>
          <span id="newsProviderBadge" class="hidden px-3 py-1 rounded-lg text-xs font-semibold text-white"></span>
        </div>
        <p class="text-sm muted mt-1">Bound to current carousel symbol</p>

        <div id="newsBox" class="mt-4 space-y-3">
          <div class="muted">Waiting for symbol…</div>
        </div>
      </div>
    </div>

  </div>

<script>
const $ = (id) => document.getElementById(id);

let currentSymbol = null;
let ws = null;

function setWsStatus(t){ $("wsStatus").textContent = t; }

function renderBots(bots){
  const box = $("botsList");
  box.innerHTML = "";
  for(const b of bots){
    const d = document.createElement("div");
    d.className = "chip rounded-2xl p-4";
    d.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-semibold">${b.label}</div>
        <div class="text-xs muted">${b.horizon}</div>
      </div>
      <div class="mt-2 text-sm">
        <span class="font-semibold">${b.signal}</span>
        <span class="muted">• conf ${b.confidence}</span>
      </div>
      <div class="mt-2 text-xs muted">${b.rationale || ""}</div>
    `;
    box.appendChild(d);
  }
}

function renderNews(pack){
  const box = $("newsBox");
  const badge = $("newsProviderBadge");

  if(!pack || !pack.items || !pack.items.length){
    box.innerHTML = `<div class="muted">No articles available</div>`;
    badge.classList.add("hidden");
    return;
  }

  badge.classList.remove("hidden");
  badge.textContent = pack.provider === "mock" ? "MOCK DATA" : pack.provider;
  badge.className = `px-3 py-1 rounded-lg text-xs font-semibold text-white ${
    pack.provider === "mock" ? "badge-mock" : "badge-real"
  }`;

  box.innerHTML = pack.items.map(n => `
    <div class="chip rounded-2xl p-4">
      <div class="text-sm font-semibold">${n.title}</div>
      <div class="text-xs muted mt-1">
        ${n.source} • ${n.publishedAt ? new Date(n.publishedAt).toLocaleString() : ""}
      </div>
      <div class="text-xs muted mt-2">${n.summary || ""}</div>
    </div>
  `).join("");
}

async function getJSON(url){
  const r = await fetch(url);
  const t = await r.text();
  return JSON.parse(t);
}

function connectWS(){
  const proto = location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${proto}://${location.host}/ws`);

  ws.onopen = () => setWsStatus("WS: live ✅");
  ws.onclose = () => setWsStatus("WS: closed ⚠️");
  ws.onerror = () => setWsStatus("WS: error ⚠️");

  ws.onmessage = async (ev) => {
    const msg = JSON.parse(ev.data);
    $("lastEvent").textContent = `${msg.type} • ${new Date(msg.ts).toLocaleTimeString()}`;

    if(msg.type === "carousel_tick"){
      currentSymbol = msg.payload.symbol;
      $("liveSymbol").textContent = currentSymbol;
      $("marketState").textContent =
        msg.payload.market.open ? "OPEN" : msg.payload.market.reason;
    }

    if(msg.type === "bot_fight"){
      const f = msg.payload.features || {};
      $("priceBox").textContent = f.price ? `$${Number(f.price).toFixed(2)}` : "—";
      $("chgBox").textContent = f.changePercent !== undefined ? `${f.changePercent.toFixed(2)}%` : "—";
      $("sentBox").textContent = f.avgSent !== undefined ? f.avgSent.toFixed(2) : "—";
      $("winnerBox").textContent = msg.payload.winner;
      $("marketDetail").textContent =
        `Market: ${msg.payload.market.open ? "OPEN" : "CLOSED"} • Trades: ${msg.payload.tradesAllowed ? "YES" : "NO"}`;

      renderBots(msg.payload.bots || []);

      if(currentSymbol){
        const news = await getJSON(`/api/news/${currentSymbol}`);
        renderNews(news);
      }
    }
  };
}

connectWS();
</script>

</body>
</html>
